!function(){"use strict";class e{constructor(e,t,s,i){this.id=e,this.name=t,this.status=+s;const d=new Date(+i);this.created=d.toLocaleString(),this.node=document.createElement("div"),this.node.classList.add("helpdesk__item");const a=document.createElement("div");a.classList.add("helpdesk__item__status"),this.status?a.classList.add("helpdesk__item__done"):a.classList.add("helpdesk__item__wait");const o=document.createElement("div");o.classList.add("helpdesk__item__name"),o.innerText=this.name;const n=document.createElement("div");n.classList.add("helpdesk__item__date"),n.innerText=this.created;const l=document.createElement("div");l.classList.add("helpdesk__item__controls");const c=document.createElement("div");c.classList.add("helpdesk__item__edit");const r=document.createElement("div");r.classList.add("helpdesk__item__delete"),l.append(c,r),this.node.append(a,o,n,l)}}class t{constructor(){this.closeModal=this.closeModal.bind(this)}createModal(){this.modal=document.createElement("div"),this.modal.classList.add("helpdesk__modal"),this.modal.innerHTML='<form class="helpdesk__form" novalidate>\n    <h3>Добавить тикет</h3>\n    <div class="label">Краткое описание<input type="text" name="item-name" class="helpdesk__form__field item_name" required></div>\n    <div class="label">Подробное описание<textarea name="item-description" class="helpdesk__form__field item_description" required></textarea></div>\n    <div class="controls">\n      <button type="button" class="close">Отмена</button>\n      <button>Ok</button>\n    </div>\n  </form>',this.form=this.modal.querySelector(".helpdesk__modal .helpdesk__form"),this.inputName=this.form.querySelector(".item_name"),this.inputDescription=this.form.querySelector(".item_description"),this.close=this.modal.querySelector(".helpdesk__modal .close")}showModal(e,s){document.body.appendChild(this.modal),this.close.addEventListener("click",this.closeModal),[...this.form.querySelectorAll(".helpdesk__form__field")].forEach((e=>e.addEventListener("focus",t.removeError))),s&&(this.inputName.value=s.name,this.inputDescription.value=s.description),this.form.addEventListener("submit",this.checkValidity.bind(this,e))}showWarning(e){this.modal=document.createElement("div"),this.modal.classList.add("helpdesk__modal"),this.modal.innerHTML='<div class="helpdesk__form">\n    <h3>Удалить тикет</h3>\n    <div>Вы уверены, что хотите удалить тикет? Это действие необратимо.</div>\n    <div class="controls">\n      <button class="ok">OK</button>\n      <button class="close">Отмена</button>\n    </div>\n  </div>',document.body.appendChild(this.modal),this.close=this.modal.querySelector(".helpdesk__modal .close"),this.close.addEventListener("click",this.closeModal),this.modal.querySelector(".helpdesk__modal .ok").addEventListener("click",e)}closeModal(){this.modal.remove()}checkValidity(e,s){if(s.preventDefault(),!s.currentTarget.checkValidity())return this.inputName.validity.valid||t.showError(this.inputName,"введите краткое описание"),void(this.inputDescription.validity.valid||t.showError(this.inputDescription,"введите подробное описание"));e()}static showError(e,t){const s=document.createElement("div");s.classList.add("error"),s.innerText=t,e.closest("div").append(s),s.style.left=e.offsetLeft+e.offsetWidth/2-s.offsetWidth/2+"px",s.style.top=`${e.offsetTop+e.offsetHeight}px`}static removeError(e){const t=e.currentTarget.closest("div").querySelector(".error");t&&t.remove()}}class s{constructor(e){this.server=`${e}tickets`}get(e){const t=new XMLHttpRequest;return new Promise(((s,i)=>{t.open("GET",`${this.server}${e}`),t.addEventListener("load",(()=>{if(t.status>=200&&t.status<300)try{s(t.response)}catch(e){i(e)}})),t.send()}))}post(e,t,s){const i=new XMLHttpRequest;return new Promise((d=>{i.open(e,`${this.server}${t}`),i.addEventListener("load",(()=>{204===i.status&&d(i.response)})),i.send(s)}))}allTickets(){return this.get("?method=allTickets")}ticketById(e){return this.get(`?method=ticketById&id=${e}`)}createTicket(e,t,s){const i=new URLSearchParams;return i.append("name",e),i.append("description",t),i.append("status",s),this.post("POST","?method=createTicket",i)}removeById(e){const t=new URLSearchParams;return t.append("curid",e),this.post("DELETE",`/${e}`,t)}changeStatus(e){const t=new URLSearchParams;return t.append("curid",e),this.post("PUT",`/${e}`,t)}editTicket(e,t,s){const i=new URLSearchParams;return i.append("curid",e),i.append("name",t),i.append("description",s),this.post("PUT",`/${e}`,i)}}new class{constructor(e){this.table=e.querySelector(".helpdesk__table"),this.add=e.querySelector(".helpdesk__add"),this.modal=new t,this.request=new s("http://localhost:7070/"),this.items=[],this.addItem=this.addItem.bind(this),this.editItem=this.editItem.bind(this),this.changeItem=this.changeItem.bind(this)}init(){this.add.addEventListener("click",(()=>{this.modal.createModal(),this.modal.showModal(this.addItem)})),this.showTable()}showTable(){this.request.allTickets().then((t=>{this.items=[],this.table.innerHTML="",JSON.parse(t).forEach((t=>{const s=new e(t.id,t.name,t.status,t.created);this.items.push(s)}));for(const e of this.items)this.table.append(e.node);this.table.addEventListener("click",this.changeItem)}))}addItem(){this.modal.closeModal(),this.request.createTicket(this.modal.inputName.value,this.modal.inputDescription.value,0).then((()=>{this.showTable()}))}changeItem(e){const t=e.target.closest("div.helpdesk__item"),s=this.items.find((e=>e.node===t));if(e.target.classList.contains("helpdesk__item__status")&&this.editItemStatus(s.id),e.target.classList.contains("helpdesk__item__name")||e.target.classList.contains("helpdesk__item__description")){const e=t.querySelector(".helpdesk__item__description");e?e.remove():this.showItemDescription(s)}e.target.classList.contains("helpdesk__item__edit")&&(s.description?(this.modal.createModal(),this.modal.showModal((()=>this.editItem(s)),s)):this.request.ticketById(s.id).then((e=>{const{description:t}=JSON.parse(e);s.description=t,this.modal.createModal(),this.modal.showModal((()=>this.editItem(s)),s)}))),e.target.classList.contains("helpdesk__item__delete")&&this.modal.showWarning((()=>this.deleteItem(s.id)))}editItem(e){this.modal.closeModal(),this.request.editTicket(e.id,this.modal.inputName.value,this.modal.inputDescription.value).then((()=>{this.showTable()}))}editItemStatus(e){this.request.changeStatus(e).then((()=>{this.showTable()}))}deleteItem(e){this.modal.closeModal(),this.request.removeById(e).then((()=>{this.showTable()}))}showItemDescription(e){if(e.description){const t=document.createElement("div");t.classList.add("helpdesk__item__description"),t.innerText=e.description,e.node.append(t)}else this.request.ticketById(e.id).then((t=>{const s=document.createElement("div");s.classList.add("helpdesk__item__description"),e.description=JSON.parse(t).description,s.innerText=e.description,e.node.append(s)}))}}(document.querySelector(".helpdesk")).init()}();